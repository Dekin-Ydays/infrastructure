---
- name: Create minio group
  ansible.builtin.group:
    name: minio
    system: yes
    state: present

- name: Create minio user
  ansible.builtin.user:
    name: minio
    group: minio
    system: yes
    shell: /sbin/nologin
    create_home: no
    state: present

- name: Create MinIO data directory
  ansible.builtin.file:
    path: "{{ minio_data_dir }}"
    state: directory
    owner: minio
    group: minio
    mode: '0750'

- name: Get system architecture for MinIO
  ansible.builtin.command: dpkg --print-architecture
  register: dpkg_arch
  changed_when: false

- name: Download MinIO server binary
  ansible.builtin.get_url:
    url: "https://dl.min.io/server/minio/release/linux-{{ dpkg_arch.stdout }}/minio"
    dest: /usr/local/bin/minio
    mode: '0755'
    owner: root
    group: root

- name: Download MinIO client binary
  ansible.builtin.get_url:
    url: "https://dl.min.io/client/mc/release/linux-{{ dpkg_arch.stdout }}/mc"
    dest: /usr/local/bin/mc
    mode: '0755'
    owner: root
    group: root

- name: Create MinIO environment file
  ansible.builtin.copy:
    dest: /etc/default/minio
    content: |
      MINIO_ROOT_USER={{ minio_access_key }}
      MINIO_ROOT_PASSWORD={{ minio_secret_key }}
      MINIO_VOLUMES="{{ minio_data_dir }}"
      MINIO_OPTS="--console-address :{{ minio_console_port }}"
    owner: root
    group: minio
    mode: '0640'
  notify: restart minio

- name: Create MinIO systemd service
  ansible.builtin.template:
    src: minio.service.j2
    dest: /etc/systemd/system/minio.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart minio

- name: Enable and start MinIO service
  ansible.builtin.systemd:
    name: minio
    enabled: yes
    state: started
    daemon_reload: yes

- name: Wait for MinIO to be ready
  ansible.builtin.wait_for:
    port: "{{ minio_api_port }}"
    delay: 5
    timeout: 60

- name: Configure MinIO client alias
  ansible.builtin.command:
    cmd: mc alias set local http://127.0.0.1:{{ minio_api_port }} {{ minio_access_key }} {{ minio_secret_key }}
  changed_when: false

- name: Create MinIO bucket
  ansible.builtin.command:
    cmd: mc mb --ignore-existing local/{{ minio_bucket_name }}
  register: mc_mb_result
  changed_when: "'Bucket created successfully' in mc_mb_result.stdout"
